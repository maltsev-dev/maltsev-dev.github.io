<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <title>dev_stories</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://maltsev-dev.github.io/style.css">
    <link rel="stylesheet" href="https://maltsev-dev.github.io/color/orange.css">

        <link rel="stylesheet" href="https://maltsev-dev.github.io/color/background_blue.css">
    
    <link rel="stylesheet" href="https://maltsev-dev.github.io/font-quicksand.css">


    
        <link rel="shortcut icon" type="image/png" href="/favicon.png">
    
    <meta property="og:site_name" content="dev_stories"><meta property="og:type" content="article">
    <meta property="og:title" content="Basic Embedded Rust Flow (Cortex-M)"><meta property="og:url" content="https://maltsev-dev.github.io/emb-rust-flow/"><meta property="og:image" content="https://github.com/maltsev-dev/favicon.png">

    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://maltsev-dev.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            busy hands == happy heart
                        
                    </div>
                </a>
            </div>
        </div>

        
        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://maltsev-dev.github.io/archive">archive</a></li>
            
                <li><a href="https://maltsev-dev.github.io/tags/project/">projects</a></li>
            
                <li><a href="https://maltsev-dev.github.io/tags/embedded/">embedded</a></li>
            
                <li><a href="https://maltsev-dev.github.io/tags/rust/">rust</a></li>
            
                <li><a href="https://maltsev-dev.github.io/about">about</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://maltsev-dev.github.io/emb-rust-flow/">Basic Embedded Rust Flow (Cortex-M)</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2025-07-11
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://maltsev-dev.github.io/tags/rust/">#rust</a>&nbsp;
                <a class="post-tag" href="https://maltsev-dev.github.io/tags/embedded/">#embedded</a>&nbsp;
                <a class="post-tag" href="https://maltsev-dev.github.io/tags/basic/">#basic</a></span>
    

        
        <div class="post-content">
            <p>üü† A must-have template for creating a Rust project for microcontrollers.</p>
<span id="continue-reading"></span>
<hr />
<style>
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    vertical-align: top;
  }
  th {
    background-color: #f59140;
    color: white;
    text-align: center;
  }
  td:first-child {
    width: 25%;
    font-weight: bold;
  }
</style>
<table>
<thead>
<tr>
<th>Step</th>
<th>Goal</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>Creating a project</td>
<td>Starting with a clean Rust project</td>
<td>Creating a `cargo new` structure with `main.rs`</td>
</tr>
<tr>
<td>Configuring `.cargo/config.toml`</td>
<td>Specifying target and runner (`probe-rs`, `qemu`, etc.)</td>
<td>Compiling for STM32 and automatically running the firmware</td>
</tr>
<tr>
<td>Creating `rust-toolchain.toml`</td>
<td>Lock nightly version and components</td>
<td>Unified environment on all machines</td>
</tr>
<tr>
<td>Add `memory.x`</td>
<td>Detect microcontroller memory map</td>
<td>Linking works correctly, firmware is loaded</td>
</tr>
<tr>
<td>Add `Embed.toml`</td>
<td>Configure `probe-rs` (chip, speed, RTT)</td>
<td>You can flash, run, view `defmt` logs</td>
</tr>
<tr>
<td>Add dependencies</td>
<td>Connect HAL, cortex-m, panic, defmt</td>
<td>You can access STM32 peripherals in Rust</td>
</tr>
<tr>
<td>Implementation of `#[panic_handler]`</td>
<td>Ensure correct handling of `panic!`</td>
<td>Error-free compilation, correct debugging</td>
</tr>
<tr>
<td>Definition of `#[entry] fn main()`</td>
<td>Start point of the program</td>
<td>Code runs after reset of the microcontroller</td>
</tr>
<tr>
<td>Configuring `RTT / semihosting`</td>
<td>Add text output for debugging</td>
<td>Messages can be printed via `defmt::info!`</td>
</tr>
<tr>
<td>Interrupt handling</td>
<td>Add reactions to timers, UART, external events</td>
<td>Interrupts work, you can react to events</td>
</tr>
<tr>
<td>Compilation and firmware</td>
<td>Checking the entire pipeline</td>
<td>Working STM32 firmware in Rust</td>
</tr>
</tbody>
</table>
<h3 id="pushpin-1-project-setup">üìå 1. Project Setup</h3>
<h4 id="white-check-mark-project-creation">‚úÖ Project Creation</h4>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">cargo</span><span> new</span><span style="color:#ffb964;"> --bin</span><span> my_project
</span><span>cd my_project
</span></code></pre>
<h4 id="white-check-mark-add-target-and-toolchain">‚úÖ Add target and toolchain</h4>
<p>Create file <code>rust-toolchain.toml</code>:</p>
<pre data-lang="toml" style="background-color:#151515;color:#e8e8d3;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[</span><span style="color:#ffb964;">toolchain</span><span>]
</span><span style="color:#ffb964;">channel </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">nightly-2022-06-28</span><span style="color:#556633;">&quot;   </span><span style="color:#888888;"># or stable channel = &quot;1.86&quot;
</span><span style="color:#ffb964;">components </span><span>= [</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">rust-src</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">rustfmt</span><span style="color:#556633;">&quot;</span><span>]
</span><span style="color:#ffb964;">targets </span><span>= [</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">thumbv6m-none-eabi</span><span style="color:#556633;">&quot;</span><span>]
</span></code></pre>
<p>Create file <code>.cargo/config.toml</code>:</p>
<pre data-lang="toml" style="background-color:#151515;color:#e8e8d3;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[</span><span style="color:#ffb964;">build</span><span>]
</span><span style="color:#ffb964;">target </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">thumbv6m-none-eabi</span><span style="color:#556633;">&quot;
</span><span>
</span><span>[</span><span style="color:#ffb964;">target</span><span>.</span><span style="color:#ffb964;">thumbv6m-none-eabi</span><span>]
</span><span style="color:#ffb964;">rustflags </span><span>= [
</span><span>  </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">-C</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">link-arg=--nmagic</span><span style="color:#556633;">&quot;</span><span>,
</span><span>  </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">-C</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">link-arg=-Tlink.x</span><span style="color:#556633;">&quot;</span><span>,
</span><span>  </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">-C</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">link-arg=-Tdefmt.x</span><span style="color:#556633;">&quot;</span><span>,
</span><span>  </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">-C</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">no-vectorize-loops</span><span style="color:#556633;">&quot;</span><span>,
</span><span>]
</span><span style="color:#ffb964;">runner </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">elf2uf2-rs -d</span><span style="color:#556633;">&quot;   </span><span style="color:#888888;"># –∏–ª–∏ –¥—Ä—É–≥–æ–π, —Å–º. –Ω–∏–∂–µ
</span></code></pre>
<h5 id="qemu-runner">QEMU Runner</h5>
<pre data-lang="toml" style="background-color:#151515;color:#e8e8d3;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#ffb964;">runner </span><span>= </span><span style="color:#556633;">&quot;&quot;&quot;
</span><span style="color:#99ad6a;">  qemu-system-arm \
</span><span style="color:#99ad6a;">  -cpu cortex-m3 \
</span><span style="color:#99ad6a;">  -machine lm3s6965evb \
</span><span style="color:#99ad6a;">  -nographic \
</span><span style="color:#99ad6a;">  -semihosting-config enable=on,target=native
</span><span style="color:#556633;">&quot;&quot;&quot;
</span></code></pre>
<h5 id="probe-rs-runner">probe-rs Runner</h5>
<pre data-lang="toml" style="background-color:#151515;color:#e8e8d3;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#ffb964;">runner </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">probe-rs run</span><span style="color:#556633;">&quot;
</span></code></pre>
<h5 id="jigsaw-embed-toml-configuration">üß© Embed.toml configuration</h5>
<p>To run via <code>probe-rs</code>
Create <code>Embed.toml</code> file in the project root:</p>
<pre data-lang="toml" style="background-color:#151515;color:#e8e8d3;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[</span><span style="color:#ffb964;">default</span><span>]
</span><span style="color:#ffb964;">chip </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">nrf52840</span><span style="color:#556633;">&quot;   </span><span style="color:#888888;"># or other: stm32f103c8, rp2040, atsamd21g18, etc.
</span><span style="color:#ffb964;">probe </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">Auto</span><span style="color:#556633;">&quot;      </span><span style="color:#888888;"># you can specify a specific one (by serial or by name)
</span><span style="color:#ffb964;">speed </span><span>= </span><span style="color:#cf6a4c;">1000        </span><span style="color:#888888;"># SWD/JTAG frequency in kHz
</span><span>
</span><span>[</span><span style="color:#ffb964;">default</span><span>.</span><span style="color:#ffb964;">rtt</span><span>]
</span><span style="color:#ffb964;">enabled </span><span>= true
</span><span style="color:#ffb964;">channels </span><span>= [{ </span><span style="color:#ffb964;">name </span><span>= </span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">defmt</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#ffb964;">up </span><span>= true, </span><span style="color:#ffb964;">down </span><span>= false }]
</span></code></pre>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">cargo</span><span> run ‚Äî flashing and launching
</span><span style="color:#ffb964;">cargo</span><span> embed ‚Äî flashing only
</span><span style="color:#ffb964;">cargo</span><span> embed</span><span style="color:#ffb964;"> --reset-halt</span><span> ‚Äî stop at startup
</span><span style="color:#ffb964;">cargo</span><span> embed</span><span style="color:#ffb964;"> --list-probes</span><span> ‚Äî list of available programmers
</span><span style="color:#ffb964;">cargo</span><span> embed</span><span style="color:#ffb964;"> --chip</span><span> rp2040 ‚Äî specify the chip manually
</span></code></pre>
<h4 id="white-check-mark-linking-and-memory">‚úÖ Linking and Memory</h4>
<p>create file <code>memory.x</code> file in the project root</p>
<pre data-lang="ld" style="background-color:#151515;color:#e8e8d3;" class="language-ld "><code class="language-ld" data-lang="ld"><span style="color:#8fbfdc;">MEMORY
</span><span>{
</span><span>  </span><span style="color:#ffb964;">FLASH</span><span> : </span><span style="color:#8fbfdc;">ORIGIN</span><span> = </span><span style="color:#cf6a4c;">0x08000000</span><span>, </span><span style="color:#8fbfdc;">LENGTH</span><span> = </span><span style="color:#cf6a4c;">256K
</span><span>  </span><span style="color:#ffb964;">RAM</span><span>   : </span><span style="color:#8fbfdc;">ORIGIN</span><span> = </span><span style="color:#cf6a4c;">0x20000000</span><span>, </span><span style="color:#8fbfdc;">LENGTH</span><span> = </span><span style="color:#cf6a4c;">64K
</span><span>}
</span></code></pre>
<blockquote>
<p>Used by the linker (<code>link.x</code>) to determine the address space of the chip.</p>
</blockquote>
<hr />
<h3 id="pushpin-2-panic-handler">üìå 2. Panic Handler</h3>
<p>Without defining <code>#[panic_handler]</code> the project will not compile.</p>
<pre data-lang="rust" style="background-color:#151515;color:#e8e8d3;" class="language-rust "><code class="language-rust" data-lang="rust"><span>use core::panic::PanicInfo;
</span><span>
</span><span>#[</span><span style="color:#ffb964;">panic_handler</span><span>]
</span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">panic</span><span>(</span><span style="color:#ffb964;">_info</span><span>: &amp;PanicInfo) -&gt; ! {
</span><span>    </span><span style="color:#8fbfdc;">loop </span><span>{}
</span><span>}
</span></code></pre>
<hr />
<h3 id="pushpin-3-main-function">üìå 3. Main Function</h3>
<p>add dependencies:</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">cargo</span><span> add cortex-m</span><span style="color:#ffb964;"> --features</span><span> inline-asm
</span><span style="color:#ffb964;">cargo</span><span> add cortex-m-rt
</span></code></pre>
<pre data-lang="rust" style="background-color:#151515;color:#e8e8d3;" class="language-rust "><code class="language-rust" data-lang="rust"><span>use cortex_m_rt::entry;
</span><span>
</span><span>#[</span><span style="color:#ffb964;">entry</span><span>]
</span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">main</span><span>() -&gt; ! {
</span><span>    </span><span style="color:#8fbfdc;">loop </span><span>{}
</span><span>}
</span></code></pre>
<hr />
<h3 id="pushpin-4-text-output-semihosting">üìå 4. Text output: Semihosting</h3>
<p>To output messages to the host (usually via <code>QEMU</code> or debug probe):</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">cargo</span><span> add cortex-m-semihosting
</span></code></pre>
<pre data-lang="rust" style="background-color:#151515;color:#e8e8d3;" class="language-rust "><code class="language-rust" data-lang="rust"><span>use cortex_m_rt::entry;
</span><span>use cortex_m_semihosting::hprintln;
</span><span>
</span><span>#[</span><span style="color:#ffb964;">entry</span><span>]
</span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">main</span><span>() -&gt; ! {
</span><span>    hprintln!(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">Start program</span><span style="color:#556633;">&quot;</span><span>).unwrap();
</span><span>    </span><span style="color:#8fbfdc;">loop </span><span>{}
</span><span>}
</span></code></pre>
<blockquote>
<p>Semihosting is slow, but convenient for debugging. Works only with debugger/QEMU support.</p>
</blockquote>
<hr />
<h3 id="pushpin-5-interrupts-exceptions-e-g-systick">üìå 5. Interrupts / Exceptions (e.g. SysTick)</h3>
<pre data-lang="rust" style="background-color:#151515;color:#e8e8d3;" class="language-rust "><code class="language-rust" data-lang="rust"><span>use cortex_m_rt::exception;
</span><span>use cortex_m_semihosting::hprintln;
</span><span>
</span><span>#[</span><span style="color:#ffb964;">exception</span><span>]
</span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">SysTick</span><span>() {
</span><span>    hprintln!(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">SysTick interrupt</span><span style="color:#556633;">&quot;</span><span>).ok();
</span><span>}
</span></code></pre>
<hr />
<h3 id="arrows-counterclockwise-summary-of-steps">üîÑ Summary of steps</h3>
<ol>
<li><strong>Initialize project</strong>: <code>cargo new</code>, configure <code>.cargo/config.toml</code>, <code>memory.x</code>, <code>rust-toolchain.toml</code></li>
<li><strong>Add dependencies</strong>: <code>cortex-m</code>, <code>cortex-m-rt</code>, <code>cortex-m-semihosting</code></li>
<li><strong>Define</strong>:</li>
</ol>
<ul>
<li><code>#[entry]</code></li>
<li><code>#[panic_handler]</code></li>
<li><code>#[exception]</code></li>
</ul>
<ol start="4">
<li><strong>Configure runner</strong>: depends on environment (<code>probe-rs</code>, <code>QEMU</code>, <code>elf2uf2</code>, etc.)</li>
<li><strong>Compile</strong>: <code>cargo build</code>, <code>cargo run</code> (if runner is configured)</li>
</ol>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">Read other posts?</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://maltsev-dev.github.io/emb-cpu-data-flow/">
                            <span class="button__icon">‚Üê</span>&nbsp;
                            <span class="button__text">CPU‚ÄìPeripheral I&#x2F;O Communication: Approaches and Trade-offs</span>
                        </a>
                    </span>
                
                
                    <span class="button next">
                        <a href="https://maltsev-dev.github.io/emb-registers/">
                            <span class="button__text">MCU Registers</span>&nbsp;
                            <span class="button__icon">‚Üí</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>


<footer class="footer">
    <div class="footer__inner">
            <div class="copyright copyright--user"><div class="copyright">
    <span>¬© 2025 A.Maltsev</span>
    <span class="copyright-theme-sep"> | </span>
    <span><img src="https://visitor-badge.laobi.icu/badge?page_id=maltsev-dev.github.io&right_color=orange" alt="Visitors"></span>
</div>
</div>
        </div>
</footer>


</div>
</body>

</html>